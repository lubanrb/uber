# Luban environment profile

# Aliases
# =======

# Expand aliases under non-interactive shell
if [ -z "$PS1" ]; then
  shopt -s expand_aliases
fi

alias uber='source <%= app_path %>/.envrc'
alias unset_uber='source <%= app_path %>/.unset_envrc'

uber

# Convenient funtions
# ===================

lubenv() {
  if [ -z $1 ]; then
    { for path in <%= env_path %>/*/*; do
        echo ${path##*env/}
      done
    } | sort | uniq
  else
    if [ -e <%= env_path %>/$1/.envrc ]; then
      source <%= env_path %>/$1/.envrc
    else
      echo Environment \"$1\" does NOT exist.
    fi
  fi
}

unset_lubenv() {
  if [ -z $1 ]; then
    echo Error! Environment name is MISSING!
  else
    if [ -e <%= env_path %>/$1/.envrc ]; then
      source <%= env_path %>/$1/.unset_envrc
    else
      echo Environment \"$1\" does NOT exist.
    fi
  fi
}

which_lubenv() {
  if [ -n "${LUBAN_ROOT:+x}" ]; then
    # Check current working environment
    local current_env=${LUBAN_ROOT##*env/}
    echo You are using environment \"$current_env\" - $LUBAN_ROOT
  elif [ -n "${LUBAN_UBER:+x}" ]; then
    # Check Uber environment
    local uber_env=${LUBAN_UBER##*env/}
    echo You are using Uber environment \"$uber_env\" - $LUBAN_UBER
  else
    echo No environments are activated.
  fi
}


# Bash completions for Luban
# ==========================

_luban_environments() {
  COMPREPLY=()
  local word="${COMP_WORDS[COMP_CWORD]}"
  local environments="$(lubenv)"

  if [ "$COMP_CWORD" -eq 1 ]; then
    COMPREPLY=( $(compgen -W "$environments" -- "$word") )
  fi
}

complete -F _luban_environments lubenv unset_lubenv


# Bash completions for Luban
# ==========================

_upsearch() {
  local root_path=$(pwd)
  while [[ "$root_path" != "" && ! -e "$root_path/$1"  ]]; do
    root_path=${root_path%/*}
  done
  echo "$root_path"
}

_luban_commands() {
  echo `$@ -h 2>/dev/null | awk '/Commands:/{p=1;next}/^\s*$/{p=0}p {print $1}'`
}

_luban_options() {
  echo `$@ -h 2>/dev/null | awk '/Options:/{p=1;next}/^\s*$/{p=0}p' | grep -o '\-\-\w*'`
}

_luban() {
  local root_path=$(_upsearch "Lubanfile.rb")
  if [ -z "$root_path" ]; then
    return
  fi

  COMPREPLY=()

  local word="${COMP_WORDS[COMP_CWORD]}"
  local line="${COMP_LINE}"

  local opts

  if [ -z "$word" ]; then
    opts=$(_luban_commands $line)
  else
    if [[ ! $word =~ "^\-\-" ]]; then
      opts=$(_luban_commands ${line% *})
    fi
  fi

  if [ -z "$opts" ]; then
    opts=$(_luban_options ${line%% --*})
  fi

  COMPREPLY=($(compgen -W "$opts" -- ${word}))
}

complete -F _luban luban
